import { useState, useEffect, useCallback } from 'react';
import { useLocation } from 'react-router-dom';
import PublicationCard from '../components/PublicationCard';
import PublicationDetailModal from '../components/PublicationDetailModal';
import PublicationsSearchForm from '../components/PublicationsSearchForm';
import Toast from '../components/common/Toast';
import { useSettings } from '../contexts/SettingsContext';
import './PublicationsPage.css';

const API_BASE_URL = 'http://127.0.0.1:8000/api';

export default function PublicationsPage() {
  const { settings } = useSettings();
  const location = useLocation();
  const [publications, setPublications] = useState([]);
  const [loading, setLoading] = useState(false);
  const [selectedPublication, setSelectedPublication] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [searchParams, setSearchParams] = useState(null);
  const [lastSearch, setLastSearch] = useState(null);  // Nova: √∫ltima busca salva
  
  // Toast state
  const [showToast, setShowToast] = useState(false);
  const [toastMessage, setToastMessage] = useState('');
  const [toastType, setToastType] = useState('info');

  const displayToast = (message, type = 'info') => {
    setToastMessage(message);
    setToastType(type);
    setShowToast(true);
  };

  // Carregar √∫ltima busca ao montar
  useEffect(() => {
    fetchLastSearch();
  }, []);

  const fetchLastSearch = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/publications/last-search`);
      const data = await response.json();
      if (data.success && data.last_search) {
        setLastSearch(data.last_search);
      }
    } catch (error) {
      console.error('Erro ao carregar √∫ltima busca:', error);
    }
  };

  const handleLoadLastSearch = useCallback(async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_BASE_URL}/publications/retrieve-last-search`);
      const data = await response.json();
      
      if (data.success) {
        const pubs = data.publicacoes || [];
        setPublications(pubs);
        
        // Preencher searchParams para exibir resumo da busca
        setSearchParams({
          dataInicio: data.search_info.data_inicio,
          dataFim: data.search_info.data_fim,
          tribunais: data.search_info.tribunais
        });
        
        displayToast(
          `üì¶ ${data.total_publicacoes} publica√ß√µes carregadas do hist√≥rico local`,
          'success'
        );
      } else {
        displayToast(data.error || 'Erro ao carregar √∫ltima busca', 'error');
      }
    } catch (error) {
      console.error('Erro ao carregar √∫ltima busca do banco:', error);
      displayToast('Erro ao conectar com o servidor', 'error');
    } finally {
      setLoading(false);
    }
  }, []);

  // Detectar navega√ß√£o do cart√£o de Controles
  useEffect(() => {
    if (location.state?.loadLastSearch) {
      handleLoadLastSearch();
      // Limpar state para n√£o recarregar ao voltar
      window.history.replaceState({}, document.title);
    }
  }, [location.state, handleLoadLastSearch]);

  // Listener para evento customizado de reload da sidebar
  useEffect(() => {
    const handleReloadFromSidebar = () => {
      handleLoadLastSearch();
    };
    
    window.addEventListener('reloadPublicationsFromSidebar', handleReloadFromSidebar);
    
    return () => {
      window.removeEventListener('reloadPublicationsFromSidebar', handleReloadFromSidebar);
    };
  }, [handleLoadLastSearch]);

  const handleSearch = useCallback(async (filters) => {
    setLoading(true);
    setSearchParams(filters);
    
    try {
      // Construir query string
      const params = new URLSearchParams();
      params.append('data_inicio', filters.dataInicio);
      params.append('data_fim', filters.dataFim);
      filters.tribunais.forEach(t => params.append('tribunais', t));
      
      // Adicionar configura√ß√£o de dias retroativos
      const retroactiveDays = settings.retroactiveDays ?? 7;
      params.append('retroactive_days', retroactiveDays);

      const response = await fetch(`${API_BASE_URL}/publications/search?${params.toString()}`);
      const data = await response.json();
      
      if (data.success) {
        const pubs = data.publicacoes || [];
        setPublications(pubs);

        // Atualizar √∫ltima busca
        fetchLastSearch();
        
        // Notificar sidebar para atualizar
        window.dispatchEvent(new Event('publicationsSearchCompleted'));

        if (pubs.length === 0) {
          displayToast('Nenhuma publica√ß√£o encontrada para os filtros selecionados', 'info');
        } else {
          const novas = data.total_novas_salvas || 0;
          displayToast(
            `‚úÖ ${data.total_publicacoes} publica√ß√µes encontradas ‚Ä¢ ${novas} novas salvas no hist√≥rico`,
            'success'
          );
        }
      } else {
        displayToast('Erro ao buscar publica√ß√µes', 'error');
      }
    } catch (error) {
      console.error('Erro ao buscar publica√ß√µes:', error);
      displayToast('Erro ao conectar com o servidor', 'error');
    } finally {
      setLoading(false);
    }
  }, [settings]);

  const handlePublicationClick = (publication) => {
    setSelectedPublication(publication);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setSelectedPublication(null);
  };

  return (
    <div className="publications-page">
      {/* Header */}
      <div className="publications-header">
        <div className="header-info">
          <h2>üì∞ Publica√ß√µes Jur√≠dicas</h2>
          <p className="header-subtitle">
            {publications.length > 0 ? (
              `${publications.length} ${publications.length === 1 ? 'publica√ß√£o encontrada' : 'publica√ß√µes encontradas'}`
            ) : (
              'Selecione os filtros e busque publica√ß√µes'
            )}
          </p>
        </div>
      </div>

      {/* Search Form */}
      <PublicationsSearchForm onSearch={handleSearch} isLoading={loading} />

      {/* Last Search Panel */}
      {lastSearch && (
        <div 
          className="last-search-panel"
          onClick={handleLoadLastSearch}
          title="Clique para carregar esta busca do hist√≥rico local"
        >
          <div className="last-search-header">
            <span className="last-search-icon">üïí</span>
            <h3 className="last-search-title">√öltima Busca</h3>
          </div>
          <div className="last-search-content">
            <div className="last-search-row">
              <div className="last-search-item">
                <span className="last-search-label">üìÖ Per√≠odo:</span>
                <span className="last-search-value">
                  {new Date(lastSearch.data_inicio + 'T00:00:00').toLocaleDateString('pt-BR')} at√© {new Date(lastSearch.data_fim + 'T00:00:00').toLocaleDateString('pt-BR')}
                </span>
              </div>
              <div className="last-search-item">
                <span className="last-search-label">‚öñÔ∏è Tribunais:</span>
                <span className="last-search-value">{lastSearch.tribunais.join(', ')}</span>
              </div>
            </div>
            <div className="last-search-row">
              <div className="last-search-item">
                <span className="last-search-label">üìä Resultados:</span>
                <span className="last-search-value">
                  {lastSearch.total_publicacoes} {lastSearch.total_publicacoes === 1 ? 'publica√ß√£o' : 'publica√ß√µes'}
                  {lastSearch.total_novas > 0 && (
                    <span className="last-search-badge">+{lastSearch.total_novas} novas</span>
                  )}
                </span>
              </div>
              <div className="last-search-item">
                <span className="last-search-label">‚è±Ô∏è Executada:</span>
                <span className="last-search-value">
                  {new Date(lastSearch.executed_at).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                  {lastSearch.duration_seconds && (
                    <span className="last-search-duration"> ({lastSearch.duration_seconds}s)</span>
                  )}
                </span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Publications List */}
      {loading ? (
        <div className="loading-container">
          <div className="spinner"></div>
          <p>Consultando tribunais selecionados...</p>
          <p className="loading-hint">2 buscas por tribunal: OAB + Nome da Advogada</p>
        </div>
      ) : publications.length === 0 && searchParams ? (
        <div className="empty-state">
          <svg className="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p>Nenhuma publica√ß√£o encontrada</p>
          <p className="empty-hint">Tente ajustar os filtros ou selecionar outro per√≠odo</p>
        </div>
      ) : publications.length === 0 && !searchParams ? (
        <div className="empty-state">
          <svg className="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p>Pronto para buscar publica√ß√µes</p>
          <p className="empty-hint">Configure os filtros acima e clique em "Buscar Publica√ß√µes"</p>
        </div>
      ) : (
        <div className="publications-grid">
          {publications.map((publication) => (
            <PublicationCard
              key={publication.id_api}
              publication={publication}
              onClick={() => handlePublicationClick(publication)}
            />
          ))}
        </div>
      )}

      {/* Detail Modal */}
      {isModalOpen && selectedPublication && (
        <PublicationDetailModal
          publication={selectedPublication}
          onClose={handleCloseModal}
        />
      )}

      {/* Toast Notifications */}
      <Toast
        isOpen={showToast}
        message={toastMessage}
        type={toastType}
        onClose={() => setShowToast(false)}
        autoCloseMs={3000}
      />
    </div>
  );
}
